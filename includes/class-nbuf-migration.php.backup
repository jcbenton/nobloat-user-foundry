<?php
/**
 * NoBloat User Foundry - Migration Orchestrator
 *
 * Orchestrates migration of user data from other WordPress user management plugins.
 * Delegates to plugin-specific mapper classes for actual migration logic.
 *
 * @package    NoBloat_User_Foundry
 * @subpackage NoBloat_User_Foundry/includes
 * @since      1.0.0
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

class NBUF_Migration {

	/**
	 * Plugin mapper registry
	 *
	 * Maps plugin slugs to their mapper class names.
	 *
	 * @var array
	 */
	private static $plugin_mappers = array(
		'ultimate-member' => 'NBUF_Migration_Ultimate_Member',
		/* Add more plugins here as we build them:
		'buddypress'      => 'NBUF_Migration_BuddyPress',
		'profile-builder' => 'NBUF_Migration_Profile_Builder',
		*/
	);

	/**
	 * Cached mapper instances
	 *
	 * @var array
	 */
	private static $mapper_instances = array();

	/**
	 * Initialize migration hooks
	 */
	public static function init() {
		/* Register AJAX handlers */
		add_action( 'wp_ajax_nbuf_detect_plugins', array( __CLASS__, 'ajax_detect_plugins' ) );
		add_action( 'wp_ajax_nbuf_get_field_mapping', array( __CLASS__, 'ajax_get_field_mapping' ) );
		add_action( 'wp_ajax_nbuf_discover_fields', array( __CLASS__, 'ajax_discover_fields' ) );
		add_action( 'wp_ajax_nbuf_suggest_mapping', array( __CLASS__, 'ajax_suggest_mapping' ) );
		add_action( 'wp_ajax_nbuf_preview_import', array( __CLASS__, 'ajax_preview_import' ) );
		add_action( 'wp_ajax_nbuf_execute_import', array( __CLASS__, 'ajax_execute_import' ) );
		add_action( 'wp_ajax_nbuf_rollback_import', array( __CLASS__, 'ajax_rollback_import' ) );
	}

	/**
	 * Get mapper instance for plugin
	 *
	 * @param string $plugin_slug Plugin slug.
	 * @return Abstract_NBUF_Migration_Plugin|null Mapper instance or null if not found
	 */
	public static function get_mapper( $plugin_slug ) {
		/* Return cached instance if exists */
		if ( isset( self::$mapper_instances[ $plugin_slug ] ) ) {
			return self::$mapper_instances[ $plugin_slug ];
		}

		/* Check if mapper class exists */
		if ( ! isset( self::$plugin_mappers[ $plugin_slug ] ) ) {
			return null;
		}

		$class_name = self::$plugin_mappers[ $plugin_slug ];

		/* Create and cache instance */
		if ( class_exists( $class_name ) ) {
			self::$mapper_instances[ $plugin_slug ] = new $class_name();
			return self::$mapper_instances[ $plugin_slug ];
		}

		return null;
	}

	/**
	 * Detect installed user management plugins
	 *
	 * @return array List of detected plugins
	 */
	public static function detect_installed_plugins() {
		$detected = array();

		foreach ( self::$plugin_mappers as $plugin_slug => $class_name ) {
			$mapper = self::get_mapper( $plugin_slug );

			if ( ! $mapper ) {
				continue;
			}

			/* Check if plugin is active */
			if ( $mapper->is_plugin_active() ) {
				$detected[] = array(
					'name'       => $mapper->get_name(),
					'slug'       => $mapper->get_slug(),
					'file'       => $mapper->get_plugin_file(),
					'user_count' => $mapper->get_user_count(),
				);
			}
		}

		return $detected;
	}

	/**
	 * Get field mapping for a plugin
	 *
	 * @param string $plugin_slug Plugin slug.
	 * @return array Field mappings
	 */
	public static function get_field_mapping( $plugin_slug ) {
		$mapper = self::get_mapper( $plugin_slug );

		if ( ! $mapper ) {
			return array();
			case 'ultimate-member':
				return self::get_ultimate_member_field_mapping();

			default:
				return array();
		}
	}

	/**
	 * Get Ultimate Member field mapping
	 *
	 * @return array Field mappings
	 */
	private static function get_ultimate_member_field_mapping() {
		return array(
			'core_fields' => array(
				'account_status'        => array(
					'source'      => 'usermeta',
					'target'      => 'nbuf_user_data.is_verified',
					'transform'   => 'um_account_status_to_verified',
					'description' => 'Account approval status â†’ Email verification',
				),
				'_um_last_login'        => array(
					'source'      => 'usermeta',
					'target'      => 'audit_log',
					'transform'   => 'um_last_login_to_audit',
					'description' => 'Last login timestamp',
				),
				'description'           => array(
					'source'      => 'usermeta',
					'target'      => 'nbuf_user_profile.bio',
					'transform'   => 'sanitize_textarea',
					'description' => 'User bio/description',
				),
				'phone_number'          => array(
					'source'      => 'usermeta',
					'target'      => 'nbuf_user_profile.phone',
					'transform'   => 'sanitize_text',
					'description' => 'Phone number',
				),
				'mobile_number'         => array(
					'source'      => 'usermeta',
					'target'      => 'nbuf_user_profile.phone',
					'transform'   => 'sanitize_text',
					'description' => 'Mobile number (fallback)',
					'priority'    => 10, /* Use only if phone_number is empty */
				),
				'country'               => array(
					'source'      => 'usermeta',
					'target'      => 'nbuf_user_profile.country',
					'transform'   => 'sanitize_text',
					'description' => 'Country',
				),
			),
			'custom_fields' => array(
				'company'     => 'nbuf_user_profile.company',
				'job_title'   => 'nbuf_user_profile.job_title',
				'address'     => 'nbuf_user_profile.address_line1',
				'city'        => 'nbuf_user_profile.city',
				'state'       => 'nbuf_user_profile.state',
				'postal_code' => 'nbuf_user_profile.postal_code',
				'zipcode'     => 'nbuf_user_profile.postal_code', /* Alternate field name */
				'website'     => 'nbuf_user_profile.website',
			),
		);
	}

	/**
	 * Preview import data
	 *
	 * @param string $plugin_slug Plugin slug.
	 * @param int    $limit       Number of users to preview.
	 * @return array Preview data
	 */
	public static function preview_import( $plugin_slug, $limit = 10 ) {
		global $wpdb;

		$preview = array();

		switch ( $plugin_slug ) {
			case 'ultimate-member':
				$users = $wpdb->get_results(
					$wpdb->prepare(
						"SELECT DISTINCT u.ID, u.user_login, u.user_email, u.display_name
						FROM {$wpdb->users} u
						INNER JOIN {$wpdb->usermeta} um ON u.ID = um.user_id
						WHERE um.meta_key LIKE 'um_%%' OR um.meta_key LIKE '_um_%%' OR um.meta_key = 'account_status'
						LIMIT %d",
						$limit
					)
				);

				foreach ( $users as $user ) {
					$preview[] = array(
						'id'           => $user->ID,
						'username'     => $user->user_login,
						'email'        => $user->user_email,
						'display_name' => $user->display_name,
						'data'         => self::get_user_import_data( $user->ID, $plugin_slug ),
					);
				}
				break;
		}

		return $preview;
	}

	/**
	 * Get user import data for preview
	 *
	 * @param int    $user_id     User ID.
	 * @param string $plugin_slug Plugin slug.
	 * @return array User data to be imported
	 */
	private static function get_user_import_data( $user_id, $plugin_slug ) {
		global $wpdb;

		$data = array();

		switch ( $plugin_slug ) {
			case 'ultimate-member':
				/* Get account status */
				$account_status = get_user_meta( $user_id, 'account_status', true );
				$data['account_status'] = $account_status ?: 'unknown';
				$data['will_verify'] = ( 'approved' === $account_status ) ? 'Yes' : 'No';

				/* Get profile fields */
				$fields = array( 'phone_number', 'mobile_number', 'description', 'country', 'company', 'job_title' );
				foreach ( $fields as $field ) {
					$value = get_user_meta( $user_id, $field, true );
					if ( $value ) {
						$data[ $field ] = $value;
					}
				}
				break;
		}

		return $data;
	}

	/**
	 * Execute import from a plugin
	 *
	 * @param string $plugin_slug Plugin slug.
	 * @param array  $options     Import options.
	 * @return array Import results
	 */
	public static function execute_import( $plugin_slug, $options = array() ) {
		$defaults = array(
			'send_emails'       => false,
			'set_verified'      => true,
			'skip_existing'     => true,
			'batch_size'        => 50,
			'batch_offset'      => 0,
		);

		$options = wp_parse_args( $options, $defaults );

		/* Get the handler method */
		$handler = null;
		foreach ( self::$supported_plugins as $plugin_file => $plugin_data ) {
			if ( $plugin_data['slug'] === $plugin_slug ) {
				$handler = $plugin_data['handler'];
				break;
			}
		}

		if ( ! $handler || ! method_exists( __CLASS__, $handler ) ) {
			return array(
				'success' => false,
				'message' => __( 'Invalid plugin or handler not found.', 'nobloat-user-foundry' ),
			);
		}

		/* Execute the migration */
		return call_user_func( array( __CLASS__, $handler ), $options );
	}

	/**
	 * Migrate users from Ultimate Member
	 *
	 * @param array $options Import options.
	 * @return array Import results
	 */
	private static function migrate_from_ultimate_member( $options ) {
		global $wpdb;

		$results = array(
			'success'    => true,
			'total'      => 0,
			'imported'   => 0,
			'skipped'    => 0,
			'errors'     => array(),
			'batch_complete' => false,
		);

		/* Get users with UM data */
		$users = $wpdb->get_results(
			$wpdb->prepare(
				"SELECT DISTINCT u.ID
				FROM {$wpdb->users} u
				INNER JOIN {$wpdb->usermeta} um ON u.ID = um.user_id
				WHERE um.meta_key LIKE 'um_%%' OR um.meta_key LIKE '_um_%%' OR um.meta_key = 'account_status'
				LIMIT %d OFFSET %d",
				absint( $options['batch_size'] ),
				absint( $options['batch_offset'] )
			)
		);

		/* Check if batch is complete */
		$results['batch_complete'] = count( $users ) < $options['batch_size'];

		/* Migrate each user */
		foreach ( $users as $user ) {
			$results['total']++;

			try {
				/* Check if already imported */
				if ( $options['skip_existing'] ) {
					$existing = NBUF_User_Data::get( $user->ID );
					if ( $existing && $existing->is_verified ) {
						$results['skipped']++;
						continue;
					}
				}

				/* Import user data */
				$imported = self::import_um_user_data( $user->ID, $options );

				if ( $imported ) {
					$results['imported']++;
				} else {
					$results['skipped']++;
				}

			} catch ( Exception $e ) {
				$results['errors'][] = sprintf(
					/* translators: %1$d: User ID, %2$s: Error message */
					__( 'User ID %1$d: %2$s', 'nobloat-user-foundry' ),
					$user->ID,
					$e->getMessage()
				);
			}
		}

		return $results;
	}

	/**
	 * Import single user data from Ultimate Member
	 *
	 * @param int   $user_id User ID.
	 * @param array $options Import options.
	 * @return bool Success
	 */
	private static function import_um_user_data( $user_id, $options ) {
		global $wpdb;

		/* Get account status */
		$account_status = get_user_meta( $user_id, 'account_status', true );
		$is_verified = ( 'approved' === $account_status ) ? 1 : 0;

		/* Create or update nbuf_user_data record */
		$user_data_table = $wpdb->prefix . 'nbuf_user_data';

		$wpdb->replace(
			$user_data_table,
			array(
				'user_id'       => $user_id,
				'is_verified'   => $is_verified,
				'verified_date' => $is_verified ? current_time( 'mysql' ) : null,
				'is_disabled'   => ( 'inactive' === $account_status || 'rejected' === $account_status ) ? 1 : 0,
			),
			array( '%d', '%d', '%s', '%d' )
		);

		/* Import profile data */
		$profile_data = array(
			'user_id' => $user_id,
		);

		/* Map fields */
		$field_map = array(
			'phone_number'  => 'phone',
			'mobile_number' => 'phone', /* Fallback */
			'description'   => 'bio',
			'country'       => 'country',
			'company'       => 'company',
			'job_title'     => 'job_title',
			'address'       => 'address_line1',
			'city'          => 'city',
			'state'         => 'state',
			'postal_code'   => 'postal_code',
			'zipcode'       => 'postal_code', /* Alternate name */
			'website'       => 'website',
		);

		foreach ( $field_map as $um_field => $nbuf_field ) {
			$value = get_user_meta( $user_id, $um_field, true );

			/* Skip if empty or already set (priority handling) */
			if ( empty( $value ) || isset( $profile_data[ $nbuf_field ] ) ) {
				continue;
			}

			/* Sanitize based on field type */
			if ( 'bio' === $nbuf_field ) {
				$profile_data[ $nbuf_field ] = sanitize_textarea_field( $value );
			} else {
				$profile_data[ $nbuf_field ] = sanitize_text_field( $value );
			}
		}

		/* Insert or update profile data if we have any fields */
		if ( count( $profile_data ) > 1 ) { /* More than just user_id */
			$profile_table = $wpdb->prefix . 'nbuf_user_profile';

			/* Check if record exists */
			$exists = $wpdb->get_var(
				$wpdb->prepare(
					"SELECT user_id FROM {$profile_table} WHERE user_id = %d",
					$user_id
				)
			);

			if ( $exists ) {
				/* Update existing */
				$wpdb->update(
					$profile_table,
					$profile_data,
					array( 'user_id' => $user_id ),
					array_fill( 0, count( $profile_data ), '%s' ),
					array( '%d' )
				);
			} else {
				/* Insert new */
				$wpdb->insert(
					$profile_table,
					$profile_data,
					array_fill( 0, count( $profile_data ), '%s' )
				);
			}
		}

		/* Log to audit if enabled */
		if ( class_exists( 'NBUF_Audit_Log' ) ) {
			NBUF_Audit_Log::log(
				$user_id,
				'users',
				'migration_imported',
				array(
					'source_plugin' => 'Ultimate Member',
					'verified'      => $is_verified,
				)
			);
		}

		return true;
	}

	/**
	 * Log import to history
	 *
	 * @param string $plugin_slug Plugin slug.
	 * @param array  $results     Import results.
	 * @return int Import history ID
	 */
	public static function log_import_history( $plugin_slug, $results ) {
		global $wpdb;

		$table_name = $wpdb->prefix . 'nbuf_import_history';

		$data = array(
			'source_plugin' => $plugin_slug,
			'imported_by'   => get_current_user_id(),
			'total_rows'    => $results['total'],
			'successful'    => $results['imported'],
			'failed'        => count( $results['errors'] ),
			'skipped'       => $results['skipped'],
			'error_log'     => wp_json_encode( $results['errors'] ),
			'imported_at'   => current_time( 'mysql' ),
		);

		$wpdb->insert( $table_name, $data );

		return $wpdb->insert_id;
	}

	/**
	 * Get import history
	 *
	 * @param int $limit Number of records to retrieve.
	 * @return array Import history records
	 */
	public static function get_import_history( $limit = 10 ) {
		global $wpdb;

		$table_name = $wpdb->prefix . 'nbuf_import_history';

		return $wpdb->get_results(
			$wpdb->prepare(
				"SELECT * FROM {$table_name} ORDER BY imported_at DESC LIMIT %d",
				$limit
			)
		);
	}

	/**
	 * AJAX: Detect installed plugins
	 */
	public static function ajax_detect_plugins() {
		check_ajax_referer( 'nbuf_migration_nonce', 'nonce' );

		if ( ! current_user_can( 'manage_options' ) ) {
			wp_send_json_error( array( 'message' => __( 'Unauthorized', 'nobloat-user-foundry' ) ) );
		}

		$detected = self::detect_installed_plugins();

		wp_send_json_success( array( 'plugins' => $detected ) );
	}

	/**
	 * AJAX: Get field mapping
	 */
	public static function ajax_get_field_mapping() {
		check_ajax_referer( 'nbuf_migration_nonce', 'nonce' );

		if ( ! current_user_can( 'manage_options' ) ) {
			wp_send_json_error( array( 'message' => __( 'Unauthorized', 'nobloat-user-foundry' ) ) );
		}

		$plugin_slug = isset( $_POST['plugin_slug'] ) ? sanitize_text_field( wp_unslash( $_POST['plugin_slug'] ) ) : '';

		if ( empty( $plugin_slug ) ) {
			wp_send_json_error( array( 'message' => __( 'Invalid plugin slug', 'nobloat-user-foundry' ) ) );
		}

		$mapping = self::get_field_mapping( $plugin_slug );

		wp_send_json_success( array( 'mapping' => $mapping ) );
	}

	/**
	 * AJAX: Preview import
	 */
	public static function ajax_preview_import() {
		check_ajax_referer( 'nbuf_migration_nonce', 'nonce' );

		if ( ! current_user_can( 'manage_options' ) ) {
			wp_send_json_error( array( 'message' => __( 'Unauthorized', 'nobloat-user-foundry' ) ) );
		}

		$plugin_slug = isset( $_POST['plugin_slug'] ) ? sanitize_text_field( wp_unslash( $_POST['plugin_slug'] ) ) : '';

		if ( empty( $plugin_slug ) ) {
			wp_send_json_error( array( 'message' => __( 'Invalid plugin slug', 'nobloat-user-foundry' ) ) );
		}

		$preview = self::preview_import( $plugin_slug, 10 );

		wp_send_json_success( array( 'preview' => $preview ) );
	}

	/**
	 * AJAX: Execute import
	 */
	public static function ajax_execute_import() {
		check_ajax_referer( 'nbuf_migration_nonce', 'nonce' );

		if ( ! current_user_can( 'manage_options' ) ) {
			wp_send_json_error( array( 'message' => __( 'Unauthorized', 'nobloat-user-foundry' ) ) );
		}

		$plugin_slug = isset( $_POST['plugin_slug'] ) ? sanitize_text_field( wp_unslash( $_POST['plugin_slug'] ) ) : '';
		$batch_offset = isset( $_POST['batch_offset'] ) ? absint( $_POST['batch_offset'] ) : 0;

		if ( empty( $plugin_slug ) ) {
			wp_send_json_error( array( 'message' => __( 'Invalid plugin slug', 'nobloat-user-foundry' ) ) );
		}

		$options = array(
			'send_emails'   => false, /* Don't send emails during migration */
			'set_verified'  => true,
			'skip_existing' => true,
			'batch_size'    => 50,
			'batch_offset'  => $batch_offset,
		);

		$results = self::execute_import( $plugin_slug, $options );

		/* Log to history on first batch */
		if ( 0 === $batch_offset ) {
			$import_id = self::log_import_history( $plugin_slug, $results );
			$results['import_id'] = $import_id;
		}

		wp_send_json_success( $results );
	}

	/**
	 * AJAX: Rollback import
	 */
	public static function ajax_rollback_import() {
		check_ajax_referer( 'nbuf_migration_nonce', 'nonce' );

		if ( ! current_user_can( 'manage_options' ) ) {
			wp_send_json_error( array( 'message' => __( 'Unauthorized', 'nobloat-user-foundry' ) ) );
		}

		$import_id = isset( $_POST['import_id'] ) ? absint( $_POST['import_id'] ) : 0;

		if ( ! $import_id ) {
			wp_send_json_error( array( 'message' => __( 'Invalid import ID', 'nobloat-user-foundry' ) ) );
		}

		/* TODO: Implement rollback logic */
		wp_send_json_error( array( 'message' => __( 'Rollback not yet implemented', 'nobloat-user-foundry' ) ) );
	}
}
